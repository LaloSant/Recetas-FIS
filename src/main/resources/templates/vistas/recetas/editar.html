<!DOCTYPE html>
<html lang="es" xmlns:th="https://www.thymeleaf.org">

<head th:replace="~{template :: head}"></head>

<body class="bg-secondary">
	<header th:replace="~{template :: header (${nomUser}, ${rol})}"></header>

	<div class="container p-4">
		<div class="row">
			<div class="container justify-content-center card m-3">
				<h1 class="text-center my-2">Editar receta</h1>
				<div class="card-body">
					<form th:action="@{/recetas/editar}" th:object="${dto}" method="post" enctype="multipart/form-data">
						<div class="my-2 border p-2">
							<div class="input-group mb-2">
								<span class="input-group-text"><i class="bi bi-file-text"></i></span>
								<span class="input-group-text" th:text="'NOMBRE'"></span>
								<input class="form-control" th:field="*{receta.nombre}" th:value="${dto.receta.nombre}" type="text" required
									minlength="3" maxlength="50">
							</div>
							<div class="input-group">
								<!-- <span class="input-group-text"><i class="bi bi-hash"></i></span>
								<span class="input-group-text" th:text="'ID RECETA'"></span>
								<input class="form-control bg-light" th:field="*{receta.idReceta}" th:value="${dto.receta.idReceta}" type="text"
									readonly> -->
								<span class="input-group-text"><i class="bi bi-person-circle"></i></span>
								<span class="input-group-text" th:text="'USUARIO'"></span>
								<span class="input-group-text" th:text="*{receta.usuario.nombre}"></span>
								<span class="input-group-text"><i class="bi bi-arrow-bar-right"></i></span>
								<span class="input-group-text"><i class="bi bi-star-half"></i></span>
								<span class="input-group-text" th:text="'CALIFICACION (X/5)'"></span>
								<span class="input-group-text" th:text="${dto.receta.calificacion}"></span>
								<input hidden th:field="*{receta.calificacion}" th:value="${dto.receta.calificacion}" type="text">
								<input hidden th:field="*{receta.visitasTotales}" th:value="${dto.receta.visitasTotales}" readonly>
								<input hidden th:field="*{receta.visitasSemanales}" th:value="${dto.receta.visitasSemanales}" readonly>
							</div>
							<div class="container text-center">
								<div class="row p-0 d-flex align-items-center">
									<div class="col col-4 p-0">
										<div class="input-group my-2 mx-0">
											<span class="input-group-text"><i class="bi bi-image"></i></span>
											<span class="input-group-text">Cambiar imagen</span>
											<input type="file" th:field="*{imagen}" class="form-control" accept=".jpg,image/jpeg"
											onchange="previewImage(event)" />
										</div>
									</div>
									<div class="col col-8 d-flex align-items-end">
										<div class="text-center my-2 ">
											<img th:src="@{/recetas/imagen/{id}(id=${dto.receta.idReceta})}" id="image-preview" class="img-thumbnail"
												style="max-width: 300px;" alt="Imagen de la receta no encontrada" accept=".jpg,image/jpeg" />
										</div>
									</div>
								</div>

							</div>
						</div>
						<div class="my-2 border p-2">
							<div class="d-flex justify-content-center mt-2">
								<h4 class="text-center">INGREDIENTES:</h4>
							</div>
							<div id="detalles-container">
								<div th:each="detalle, iterStat : *{detalles}">
									<div class="mb-3 mt-1 ms-2">
										<div class="input-group">
											<span class="input-group-text"><i class="bi bi-chevron-right"></i></span>
											<span class="input-group-text">Detalle</span>
											<input type="hidden" th:field="*{detalles[__${iterStat.index}__].idDetalle}" />
											<input type="number" step="0.1" min="0" max="1000" th:field="*{detalles[__${iterStat.index}__].cantidad}"
												class="form-control" />
											<select th:field="*{detalles[__${iterStat.index}__].ingrediente.idIngrediente}" class="form-select">
												<option value="">Seleccionar ingrediente</option>
												<option th:each="ingrediente : ${ingredientes}" th:value="${ingrediente.idIngrediente}"
													th:text="${ingrediente.nombre} + ' (' + ${ingrediente.magnitud} + ')'"
													th:selected="${ingrediente.idIngrediente == detalle.ingrediente.idIngrediente}">
												</option>
											</select>
											<span class="input-group-text" th:text="'Costo total: ' + ${detalle.costo}"></span>
											<input type="hidden" th:field="*{detalles[__${iterStat.index}__].costo}" />
										</div>
									</div>
								</div>
							</div>
							<div class="d-flex justify-content-center mt-2">
								<button type="button" class="btn btn-info" onclick="agregarDetalle()">Agregar
									Ingrediente</button>
							</div>
						</div>
						<div class="my-2 border p-2">
							<div class="">
								<h4 class="text-center">PASOS:</h4>
								<h6 class="text-center text-secondary mb-4">PARA AGREGAR IMAGENES A LOS PASOS, EDITE LA
									RECETA DESPUES DE AGREGARLA
								</h6>
							</div>
							<div id="pasos-container">
								<div th:each="paso, iterStat : *{pasos}">
									<div class="mb-3 mt-1 ms-2">
										<div class="input-group">
											<span class="input-group-text"><i class="bi bi-chevron-right"></i></span>
											<span class="input-group-text" th:text="'Paso ' + ${paso.indicePaso}"></span>
											<input type="hidden" th:field="*{pasos[__${iterStat.index}__].idPaso}" />
											<input type="text" th:field="*{pasos[__${iterStat.index}__].notas}" class="form-control" required
												minlength="10" maxlength="200" />
											<input type="file" th:field="*{pasoDTOs[__${iterStat.index}__].imagen}" class="form-control"
												accept=".jpg,image/jpeg" />
										</div>
									</div>
								</div>
							</div>
							<div class="d-flex justify-content-center mt-2">
								<button type="button" class="btn btn-info" onclick="agregarPaso()">Agregar Paso</button>
							</div>
						</div>
						<div class="box-footer d-flex justify-content-center">
							<button class="btn btn-success btn-lg">Guardar Receta</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
	<footer th:replace="~{template :: footer}"></footer>
	<script th:inline="javascript">
		/*<![CDATA[*/
		const ingredientes = /*[[${ingredientes}]]*/[];
		/*]]>*/

		let pasoIndex = /*[[${#lists.size(dto.pasos)}]]*/ 0;
		let detalleIndex = /*[[${#lists.size(dto.detalles)}]]*/ 0;

		function agregarPaso() {
			const container = document.getElementById('pasos-container');

			const pasoDiv = document.createElement('div');
			pasoDiv.className = 'mb-3 mt-1 ms-2';

			const inputGroup = document.createElement('div');
			inputGroup.className = 'input-group';

			inputGroup.innerHTML = `
						<span class="input-group-text"><i class="bi bi-chevron-right"></i></span>
						<span class="input-group-text">Paso ${pasoIndex + 1}</span>
						<input type="text" name="pasos[${pasoIndex}].notas" class="form-control" placeholder="DescripciÃ³n del paso" required minlength="10" maxlength="200" />
					`;

			pasoDiv.appendChild(inputGroup);
			container.appendChild(pasoDiv);
			pasoIndex++;
		}

		function agregarDetalle() {
			const container = document.getElementById('detalles-container');

			const detalleDiv = document.createElement('div');
			detalleDiv.className = 'mb-3 mt-1 ms-2';

			const inputGroup = document.createElement('div');
			inputGroup.className = 'input-group';

			let optionsHtml = '<option value="">Seleccionar ingrediente</option>';
			ingredientes.forEach(ingrediente => {
				optionsHtml += `<option value="${ingrediente.idIngrediente}">${ingrediente.nombre} (${ingrediente.magnitud})</option>`;
			});

			inputGroup.innerHTML = `
						<span class="input-group-text"><i class="bi bi-chevron-right"></i></span>
						<span class="input-group-text">Detalle</span>
						<input type="number" step="0.1" min="0" max="1000" name="detalles[${detalleIndex}].cantidad" class="form-control" placeholder="Cantidad"/>
						<select name="detalles[${detalleIndex}].ingrediente.idIngrediente" class="form-select">
							${optionsHtml}
						</select>
					`;

			detalleDiv.appendChild(inputGroup);
			container.appendChild(detalleDiv);
			detalleIndex++;
		}

		function previewImage(event) {
			const input = event.target;
			const imagePreview = document.getElementById('image-preview');

			if (input.files && input.files[0]) {
				const reader = new FileReader();
				reader.onload = function (e) {
					imagePreview.src = e.target.result;
					imagePreview.style.display = 'block';
					if (currentImage) currentImage.style.display = 'none';
					submitButton.disabled = false;
				};
				reader.readAsDataURL(input.files[0]);
			}
		}

	</script>
</body>

</html>